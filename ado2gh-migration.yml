trigger: none

parameters:
- name: runAzureBoardsIntegration
  displayName: 'Run Azure Boards Integration (Stage 6)'
  type: boolean
  default: true

- name: runMannequinReclamation
  displayName: 'Run Mannequin Reclamation (Stage 7)'
  type: boolean
  default: false

- name: runDisableADORepos
  displayName: 'Disable ADO Repositories (Stage 8)'
  type: boolean
  default: false

variables:
  # Variable group for migration-related PAT tokens (Stages 1-5, 7, 8)
  # Contains: GH_PAT, ADO_PAT (for migration, readiness checks, validation, rewiring, mannequin reclamation, disable repos)
  - group: core-entauto-github-migration-secrets
  
  - name: maxConcurrent
    value: 3  # Adjust based on your needs (1-5)

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: PrerequisiteValidation
    displayName: 'Stage 1: Prerequisite Validation'
    jobs:
      - job: ValidatePrerequisites
        displayName: 'Check Prerequisites'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Validate repos.csv File'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "=========================================="
                echo "PREREQUISITE VALIDATION"
                echo "=========================================="
                
                # Check if repos.csv exists
                CSV_FILE="bash/repos.csv"
                if [ ! -f "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file not found at $CSV_FILE"
                  exit 1
                fi
                echo "‚úÖ repos.csv file exists"
                
                # Check if file is not empty
                if [ ! -s "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file is empty"
                  exit 1
                fi
                echo "‚úÖ repos.csv file is not empty"
                
                # Read header and validate required columns
                HEADER=$(head -n 1 "$CSV_FILE")
                echo ""
                echo "CSV Header: $HEADER"
                echo ""
                
                # Check for required columns for migration
                REQUIRED_COLUMNS=("org" "teamproject" "repo" "github_org" "github_repo" "gh_repo_visibility")
                MISSING_COLUMNS=()
                
                for col in "${REQUIRED_COLUMNS[@]}"; do
                  if ! echo "$HEADER" | grep -q "$col"; then
                    MISSING_COLUMNS+=("$col")
                  fi
                done
                
                if [ ${#MISSING_COLUMNS[@]} -gt 0 ]; then
                  echo "‚ùå ERROR: Missing required columns in repos.csv:"
                  for col in "${MISSING_COLUMNS[@]}"; do
                    echo "  - $col"
                  done
                  exit 1
                fi
                
                echo "‚úÖ All required columns present: ${REQUIRED_COLUMNS[*]}"
                
                # Count repositories to migrate
                REPO_COUNT=$(($(wc -l < "$CSV_FILE") - 1))
                echo ""
                echo "‚úÖ Found $REPO_COUNT repositories to process"
                echo "=========================================="

  - stage: MigrationReadinessCheck
    displayName: 'Stage 2: PR & Pipeline Check'
    dependsOn: PrerequisiteValidation
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ReadinessCheck
        displayName: 'Run Readiness Check Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Migration Readiness Check'
            inputs:
              targetType: 'filePath'
              filePath: 'bash/1_pr_pipeline_check.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
      
      - job: WaitForApprovalToMigrate
        displayName: '‚è∏Ô∏è Approve to START MIGRATION'
        dependsOn: ReadinessCheck
        condition: succeeded()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review Readiness & Approve Migration'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã Active PR & Pipeline Check COMPLETED
                
                ‚ö†Ô∏è **IMPORTANT**: The next stage will migrate repositories to GitHub.
                
                ### üìä What to Review
                1. Check the readiness check logs above
                2. Verify all repositories are accessible
                3. Confirm GitHub organizations exist
                4. Ensure permissions are validated
                
                ### ‚è≠Ô∏è Next Stage: Repo Migration
                This will:
                - Migrate repositories to GitHub
                - Transfer Git history
                - Create GitHub repositories
                
                ---
                
                ‚úÖ Click **Resume** to START MIGRATION
                ‚ùå Click **Reject** to stop the pipeline
              onTimeout: 'reject'

  - stage: Migration
    displayName: 'Stage 3: Repo Migration'
    dependsOn: MigrationReadinessCheck
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RunMigration
        displayName: 'Run Migration Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Execute Migration'
            name: MigrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/2_migration.sh'
              arguments: '--csv bash/repos.csv --max-concurrent $(maxConcurrent)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 120  # 2 hours timeout for large migrations
            continueOnError: true  # Don't fail job if some repos fail

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Migration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'migration-logs'
              publishLocation: 'Container'
            continueOnError: true

  - stage: PostMigrationValidation
    displayName: 'Stage 4: Migration Validation'
    dependsOn: Migration
    condition: in(dependencies.Migration.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ValidationCheck
        displayName: 'Run Validation Script'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Post-Migration Validation'
            name: ValidationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/3_post_migration_validation.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Validation Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'validation-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Migration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "MIGRATION SUMMARY"
                echo "=========================================="
                echo "Pipeline: $(Build.DefinitionName)"
                echo "Build Number: $(Build.BuildNumber)"
                echo "Build ID: $(Build.BuildId)"
                echo ""
                echo "Artifacts published:"
                echo "  - migration-logs"
                echo "  - validation-logs"
                echo ""
                echo "Review artifacts for detailed migration results."
                echo "=========================================="
      
      - job: ReviewValidationFailures
        displayName: '‚ö†Ô∏è Review Validation Failures Before Proceeding'
        dependsOn: ValidationCheck
        condition: failed()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Validation Had Failures - Review and Approve'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚ö†Ô∏è VALIDATION FAILURES DETECTED
                
                Some repositories failed post-migration validation checks.
                
                ### üìä What to Review
                1. Download and review the **validation-logs** artifact
                2. Check which repositories failed validation
                3. Review branch counts, commit counts, and SHA mismatches
                4. Determine if failures are blockers or can be addressed later
                
                ### ‚è≠Ô∏è Next Stage: Pipeline Rewiring
                If you proceed:
                - Successfully migrated repositories will have their pipelines rewired
                - Failed repositories will be skipped in subsequent stages
                
                ### Options
                ‚úÖ Click **Resume** to continue with successful repositories
                ‚ùå Click **Reject** to stop the pipeline and fix issues first
              onTimeout: 'reject'

  - stage: PipelineRewiring
    displayName: 'Stage 5: Pipeline Rewiring'
    dependsOn: PostMigrationValidation
    condition: in(dependencies.PostMigrationValidation.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RewirePipelines
        displayName: 'Run Pipeline Rewiring'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Rewire Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/4_rewire_pipeline.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Pipeline Rewiring'
            name: RewiringTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/4_rewire_pipeline.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Rewiring Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'rewiring-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Rewiring Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "PIPELINE REWIRING SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the rewiring-logs artifact for detailed results"
                echo "Log files: pipeline-rewiring-*.txt"
                echo "=========================================="      
      - job: ReviewRewiringFailures
        displayName: '‚ö†Ô∏è Review Rewiring Failures Before Proceeding'
        dependsOn: RewirePipelines
        condition: failed()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Rewiring Had Failures - Review and Approve'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚ö†Ô∏è PIPELINE REWIRING FAILURES DETECTED
                
                Some pipelines failed to be rewired to GitHub repositories.
                
                ### üìä What to Review
                1. Download and review the **rewiring-logs** artifact
                2. Check which pipelines failed to rewire
                3. Review error messages and determine root cause
                4. Assess impact on CI/CD workflows
                
                ### ‚è≠Ô∏è Next Stage: Azure Boards Integration
                If you proceed:
                - Successfully rewired pipelines will continue to boards integration
                - Failed pipelines may need manual intervention
                
                ### Options
                ‚úÖ Click **Resume** to continue to Azure Boards Integration
                ‚ùå Click **Reject** to stop the pipeline and fix rewiring issues
              onTimeout: 'reject'
  - stage: AzureBoardsIntegration
    displayName: 'Stage 6: Boards Integration'
    dependsOn: PipelineRewiring
    condition: |
      and(
        eq('${{ parameters.runAzureBoardsIntegration }}', true),
        in(dependencies.PipelineRewiring.result, 'Succeeded', 'SucceededWithIssues')
      )
    # PAT Tokens Used: GH_PAT, ADO_PAT (from azure-boards-integration-secrets)
    # IMPORTANT: This stage uses a SEPARATE variable group with ADO_PAT having limited Boards-only scopes
    # This is NOT the same ADO_PAT used in migration stages
    variables:
      # Variable group for Azure Boards integration PAT tokens (Stage 6 only)
      # Contains: GH_PAT, ADO_PAT (separate token with limited Boards-only scopes)
      # Required scopes for ADO_PAT: Code (Read), Work Items (Read, Write), Project and Team (Read)
      - group: azure-boards-integration-secrets
    jobs:
      - job: IntegrateBoards
        displayName: 'Integrate Azure Boards with GitHub'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Azure Boards Integration Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/5_boards_integration.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Azure Boards Integration'
            name: BoardsIntegrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/5_boards_integration.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              # CRITICAL: Using ADO_PAT from azure-boards-integration-secrets variable group
              # This is a DIFFERENT token than migration ADO_PAT with Boards-only scopes
              ADO_PAT: $(ADO_PAT)
              GH_PAT: $(GH_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Azure Boards Integration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'boards-integration-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Azure Boards Integration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "AZURE BOARDS INTEGRATION SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the boards-integration-logs artifact for detailed results"
                echo "Log file: azure-boards-integration-*.log"
                echo "=========================================="
      
      - job: ReviewBoardsIntegrationFailures
        displayName: '‚ö†Ô∏è Review Boards Integration Failures'
        dependsOn: IntegrateBoards
        condition: failed()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Boards Integration Had Failures - Review and Approve'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚ö†Ô∏è AZURE BOARDS INTEGRATION FAILURES DETECTED
                
                Some repositories failed Azure Boards integration.
                
                ### üìä What to Review
                1. Download and review the **boards-integration-logs** artifact
                2. Check which repositories failed boards integration
                3. Review error messages and connection issues
                4. Verify ADO_PAT permissions for Boards integration
                
                ### ‚è≠Ô∏è Optional Next Stages
                - Stage 7: Mannequin Reclamation (Optional)
                - Stage 8: Disable ADO Repos (Optional)
                
                ### Options
                ‚úÖ Click **Resume** to continue to optional stages
                ‚ùå Click **Reject** to stop the pipeline
              onTimeout: 'reject'

  - stage: MannequinReclamation
    displayName: 'Stage 7: Mannequin Reclamation (Optional)'
    dependsOn: AzureBoardsIntegration
    condition: |
      and(
        eq('${{ parameters.runMannequinReclamation }}', true),
        in(dependencies.AzureBoardsIntegration.result, 'Succeeded', 'SucceededWithIssues', 'Failed', 'Skipped')
      )
    jobs:
      - job: WaitForApprovalToStartMannequins
        displayName: '‚è∏Ô∏è Approve to START Mannequin Reclamation'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Approve Mannequin Reclamation Process'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã OPTIONAL: MANNEQUIN RECLAMATION
                
                This stage will generate mannequin CSV, pause for your edits, then reclaim mannequins.
                
                **Process:**
                1. Generate mannequins.csv
                2. You download, edit target column, commit back
                3. Reclaim mannequins using updated CSV
                
                ---
                
                ‚úÖ Click **Resume** to START mannequin reclamation
                ‚ùå Click **Reject** to SKIP and proceed to Stage 8
              onTimeout: 'reject'
      
      - job: GenerateMannequins
        displayName: 'Generate Mannequin CSV'
        dependsOn: WaitForApprovalToStartMannequins
        condition: succeeded()
        steps:
          - checkout: self
          - task: Bash@3
            displayName: 'Install GitHub CLI & Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                gh extension install github/gh-ado2gh
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Generate Mannequins CSV'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/7_mannequin_manager.sh
                bash/7_mannequin_manager.sh generate
            env:
              GH_PAT: $(GH_PAT)
            continueOnError: true

          - task: PublishBuildArtifacts@1
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'mannequin-logs'

      - job: WaitForCSVUpdate
        displayName: '‚è∏Ô∏è MANUAL: Edit & Commit mannequins.csv'
        dependsOn: GenerateMannequins
        condition: succeeded()
        pool: server
        timeoutInMinutes: 10080
        steps:
          - task: ManualValidation@0
            displayName: 'Confirm CSV Updated and Committed'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚úèÔ∏è EDIT MANNEQUINS.CSV
                
                1. Download mannequins.csv from artifacts
                2. Edit 'target' column with GitHub usernames
                3. Commit to bash/mannequins.csv
                   ```
                   git add bash/mannequins.csv
                   git commit -m "Update mannequin mappings"
                   git push
                   ```
                4. Click Resume to reclaim mannequins
                
                ---
                
                ‚úÖ **Resume** after committing updated CSV
                ‚ùå **Reject** to skip reclamation
              onTimeout: 'reject'

      - job: ReclaimMannequins
        displayName: 'Reclaim Mannequins'
        dependsOn: WaitForCSVUpdate
        condition: succeeded()
        steps:
          - checkout: self
          - task: Bash@3
            displayName: 'Install GitHub CLI & Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                gh extension install github/gh-ado2gh
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Reclaim Mannequins'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/7_mannequin_manager.sh
                bash/7_mannequin_manager.sh reclaim
            env:
              GH_PAT: $(GH_PAT)
            continueOnError: true

          - task: PublishBuildArtifacts@1
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'mannequin-reclaim-logs'
      
      - job: ReviewMannequinFailures
        displayName: '‚ö†Ô∏è Review Mannequin Reclamation Failures'
        dependsOn: ReclaimMannequins
        condition: failed()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Mannequin Reclamation Had Failures - Review and Approve'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚ö†Ô∏è MANNEQUIN RECLAMATION FAILURES DETECTED
                
                Some mannequins failed to be reclaimed.
                
                ### üìä What to Review
                1. Download and review the **mannequin-reclaim-logs** artifact
                2. Check error messages from gh ado2gh reclaim-mannequin command
                3. Verify mannequins.csv format and target mappings
                4. Ensure target GitHub users have accepted organization invitations
                
                ### ‚è≠Ô∏è Optional Next Stage
                - Stage 8: Disable ADO Repos (Optional)
                
                ### Options
                ‚úÖ Click **Resume** to continue to Stage 8
                ‚ùå Click **Reject** to stop the pipeline
              onTimeout: 'reject'

  - stage: DisableADORepositories
    displayName: 'Stage 8: Disable ADO Repos (Optional)'
    dependsOn: 
      - AzureBoardsIntegration
      - MannequinReclamation
    condition: |
      and(
        eq('${{ parameters.runDisableADORepos }}', true),
        in(dependencies.AzureBoardsIntegration.result, 'Succeeded', 'SucceededWithIssues', 'Failed', 'Skipped'),
        in(dependencies.MannequinReclamation.result, 'Succeeded', 'SucceededWithIssues', 'Skipped', 'Canceled')
      )
    # PAT Tokens Used: GH_PAT, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: WaitForApprovalToDisableRepos
        displayName: '‚è∏Ô∏è Approve to DISABLE ADO REPOSITORIES'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review & Approve Disabling ADO Repos'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## ‚ö†Ô∏è CRITICAL: DISABLE AZURE DEVOPS REPOSITORIES
                
                **WARNING**: This stage will PERMANENTLY DISABLE repositories in Azure DevOps!
                
                ### üìä What to Review BEFORE Approving
                1. **VERIFY** all repositories migrated successfully to GitHub
                2. **CONFIRM** all validation checks passed (Stage 4)
                3. **ENSURE** all pipelines rewired successfully (Stage 5)
                4. **CHECK** Azure Boards integration completed (Stage 6)
                5. **REVIEW** mannequin reclamation (if executed in Stages 7A-7B)
                6. **DOWNLOAD AND REVIEW** all artifacts:
                   - migration-logs
                   - validation-logs
                   - rewiring-logs
                   - boards-integration-logs
                   - mannequin-generation-logs (if applicable)
                   - mannequin-reclaim-logs (if applicable)
                
                ### ‚è≠Ô∏è Next Action: Disable ADO Repositories
                This will:
                - Disable all Azure DevOps repositories listed in repos.csv
                - Make ADO repositories read-only
                - Prevent further commits to ADO repositories
                
                ### üîí Impact
                - **ADO repositories will be DISABLED**
                - Users will NOT be able to push to ADO repos
                - This action helps enforce GitHub as the source of truth
                
                ### üõ°Ô∏è Safety Note
                - You can skip this stage by clicking **Reject**
                - Only approve if you're certain migration is complete
                - This is an OPTIONAL cleanup step
                
                ---
                
                ‚úÖ Click **Resume** to DISABLE ADO REPOSITORIES
                ‚ùå Click **Reject** to SKIP this stage and complete the pipeline
              onTimeout: 'reject'
      
      - job: DisableRepositories
        displayName: 'Disable ADO Repositories'
        dependsOn: WaitForApprovalToDisableRepos
        condition: succeeded()
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Disable Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/6_disable_ado_repo.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Disable ADO Repositories'
            name: DisableReposTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/6_disable_ado_repo.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Disable Repos Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'disable-repos-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Disable ADO Repos Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "DISABLE ADO REPOSITORIES SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the disable-repos-logs artifact for detailed results"
                echo "Log file: disable-ado-repos-*.log"
                echo "=========================================="

  - stage: PipelineCompletion
    displayName: 'Pipeline Completion Summary'
    dependsOn:
      - PrerequisiteValidation
      - MigrationReadinessCheck
      - Migration
      - PostMigrationValidation
      - PipelineRewiring
      - AzureBoardsIntegration
      - MannequinReclamation
      - DisableADORepositories
    condition: always()
    jobs:
      - job: CompletionSummary
        displayName: 'Pipeline Completion Summary'
        variables:
          stage1Result: $[ stageDependencies.PrerequisiteValidation.result ]
          stage2Result: $[ stageDependencies.MigrationReadinessCheck.result ]
          stage3Result: $[ stageDependencies.Migration.result ]
          stage4Result: $[ stageDependencies.PostMigrationValidation.result ]
          stage5Result: $[ stageDependencies.PipelineRewiring.result ]
          stage6Result: $[ stageDependencies.AzureBoardsIntegration.result ]
          stage7Result: $[ stageDependencies.MannequinReclamation.result ]
          stage8Result: $[ stageDependencies.DisableADORepositories.result ]
        steps:
          - task: PowerShell@2
            displayName: 'Display Pipeline Summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "=========================================="
                Write-Host "‚úÖ MIGRATION PIPELINE COMPLETED"
                Write-Host "=========================================="
                Write-Host "Build Number: $(Build.BuildNumber)"
                Write-Host ""
                Write-Host "Stage Results:"
                Write-Host "  Stage 1: Prerequisite Validation - $(stage1Result)"
                Write-Host "  Stage 2: Migration Readiness - $(stage2Result)"
                Write-Host "  Stage 3: Migrate Repositories - $(stage3Result)"
                if ("$(stage3Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed migration (check migration-logs)"
                }
                Write-Host "  Stage 4: Post-Migration Validation - $(stage4Result)"
                if ("$(stage4Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed validation (check validation-logs)"
                }
                Write-Host "  Stage 5: Rewire Pipelines - $(stage5Result)"
                if ("$(stage5Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some pipelines failed to rewire (check rewiring-logs)"
                }
                Write-Host "  Stage 6: Azure Boards Integration - $(stage6Result)"
                if ("$(stage6Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed boards integration (check boards-integration-logs)"
                }
                Write-Host "  Stage 7: Mannequin Reclamation - $(stage7Result)"
                if ("$(stage7Result)" -eq "Canceled" -or "$(stage7Result)" -eq "Skipped") {
                    Write-Host "           ‚ÑπÔ∏è Optional stage was skipped"
                }
                Write-Host "  Stage 8: Disable ADO Repos - $(stage8Result)"
                if ("$(stage8Result)" -eq "Canceled" -or "$(stage8Result)" -eq "Skipped") {
                    Write-Host "           ‚ÑπÔ∏è Optional stage was skipped"
                }
                Write-Host ""
                Write-Host "Pipeline Status: Completed"
                Write-Host ""
                Write-Host "Status Indicators:"
                Write-Host "  ‚úÖ Succeeded - All operations completed successfully"
                Write-Host "  ‚ö†Ô∏è SucceededWithIssues - PARTIAL SUCCESS with some failures (review logs)"
                Write-Host "  ‚ùå Failed - Stage failed to complete"
                Write-Host "  ‚è∏Ô∏è Canceled - User rejected manual approval"
                Write-Host "  ‚è≠Ô∏è Skipped - Stage was skipped due to conditions/parameters"
                Write-Host ""
                Write-Host "Artifacts Available:"
                Write-Host "  - migration-logs: Repository migration details"
                Write-Host "  - validation-logs: Validation check results"
                Write-Host "  - rewiring-logs: Pipeline rewiring results"
                Write-Host "  - boards-integration-logs: Azure Boards integration results"
                Write-Host "  - mannequin-logs: Mannequin generation/reclamation (if run)"
                Write-Host "  - disable-repos-logs: ADO repository disable results (if run)"
                Write-Host ""
                Write-Host "=========================================="
