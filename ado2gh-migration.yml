trigger: none

parameters:
- name: runAzureBoardsIntegration
  displayName: 'Run Azure Boards Integration (Stage 6)'
  type: boolean
  default: true

- name: runDisableADORepos
  displayName: 'Disable ADO Repositories (Stage 7)'
  type: boolean
  default: false

variables:
  # Variable group for migration-related PAT tokens (Stages 1-7)
  # Contains: GH_PAT, ADO_PAT (for migration, readiness checks, validation, rewiring, boards integration, disable repos)
  - group: core-entauto-github-migration-secrets
  
  - name: maxConcurrent
    value: 3  # Adjust based on your needs (1-5)

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: PrerequisiteValidation
    displayName: 'Stage 1: Prerequisite Validation'
    jobs:
      - job: ValidatePrerequisites
        displayName: 'Check Prerequisites'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Validate repos.csv File'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "=========================================="
                echo "PREREQUISITE VALIDATION"
                echo "=========================================="
                
                # Check if repos.csv exists
                CSV_FILE="bash/repos.csv"
                if [ ! -f "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file not found at $CSV_FILE"
                  exit 1
                fi
                echo "‚úÖ repos.csv file exists"
                
                # Check if file is not empty
                if [ ! -s "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file is empty"
                  exit 1
                fi
                echo "‚úÖ repos.csv file is not empty"
                
                # Read header and validate required columns
                HEADER=$(head -n 1 "$CSV_FILE")
                echo ""
                echo "CSV Header: $HEADER"
                echo ""
                
                # Check for required columns for migration
                REQUIRED_COLUMNS=("org" "teamproject" "repo" "github_org" "github_repo" "gh_repo_visibility")
                MISSING_COLUMNS=()
                
                for col in "${REQUIRED_COLUMNS[@]}"; do
                  if ! echo "$HEADER" | grep -q "$col"; then
                    MISSING_COLUMNS+=("$col")
                  fi
                done
                
                if [ ${#MISSING_COLUMNS[@]} -gt 0 ]; then
                  echo "‚ùå ERROR: Missing required columns in repos.csv:"
                  for col in "${MISSING_COLUMNS[@]}"; do
                    echo "  - $col"
                  done
                  exit 1
                fi
                
                echo "‚úÖ All required columns present: ${REQUIRED_COLUMNS[*]}"
                
                # Count repositories to migrate
                REPO_COUNT=$(($(wc -l < "$CSV_FILE") - 1))
                echo ""
                echo "‚úÖ Found $REPO_COUNT repositories to process"
                echo "=========================================="

  - stage: MigrationReadinessCheck
    displayName: 'Stage 2: PR & Pipeline Check'
    dependsOn: PrerequisiteValidation
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ReadinessCheck
        displayName: 'Run Readiness Check Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Migration Readiness Check'
            inputs:
              targetType: 'filePath'
              filePath: 'bash/1_pr_pipeline_check.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
      
      - job: WaitForApprovalToMigrate
        displayName: '‚è∏Ô∏è Approve to START MIGRATION'
        dependsOn: ReadinessCheck
        condition: succeeded()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review Readiness & Approve Migration'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã Active PR & Pipeline Check COMPLETED
                
                ‚ö†Ô∏è **IMPORTANT**: The next stage will migrate repositories to GitHub.
                
                ### üìä What to Review
                1. Check the readiness check logs above
                2. Verify all repositories are accessible
                3. Confirm GitHub organizations exist
                4. Ensure permissions are validated
                
                ### ‚è≠Ô∏è Next Stage: Repo Migration
                This will:
                - Migrate repositories to GitHub
                - Transfer Git history
                - Create GitHub repositories
                
                ---
                
                ‚úÖ Click **Resume** to START MIGRATION
                ‚ùå Click **Reject** to stop the pipeline
              onTimeout: 'reject'

  - stage: Migration
    displayName: 'Stage 3: Repo Migration'
    dependsOn: MigrationReadinessCheck
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RunMigration
        displayName: 'Run Migration Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Execute Migration'
            name: MigrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/2_migration.sh'
              arguments: '--csv bash/repos.csv --max-concurrent $(maxConcurrent)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 120  # 2 hours timeout for large migrations
            continueOnError: true  # Don't fail job if some repos fail

          - task: PublishBuildArtifacts@1
            displayName: 'Publish repos_with_status.csv'
            condition: always()
            inputs:
              PathtoPublish: 'repos_with_status.csv'
              ArtifactName: 'migration-results'
              publishLocation: 'Container'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Migration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'migration-logs'
              publishLocation: 'Container'
            continueOnError: true

  - stage: PostMigrationValidation
    displayName: 'Stage 4: Migration Validation'
    dependsOn: Migration
    condition: in(dependencies.Migration.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ValidationCheck
        displayName: 'Run Validation Script'
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download repos_with_status.csv'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'migration-results'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare repos_with_status.csv'
            inputs:
              targetType: 'inline'
              script: |
                # Move repos_with_status.csv to root for scripts to use
                if [ -f "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" ]; then
                  cp "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" "$(System.DefaultWorkingDirectory)/repos_with_status.csv"
                  echo "‚úÖ repos_with_status.csv loaded ($(wc -l < repos_with_status.csv) lines)"
                else
                  echo "##[error]repos_with_status.csv not found in artifacts"
                  exit 1
                fi

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Post-Migration Validation'
            name: ValidationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/3_post_migration_validation.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Validation Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'validation-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Migration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "MIGRATION SUMMARY"
                echo "=========================================="
                echo "Pipeline: $(Build.DefinitionName)"
                echo "Build Number: $(Build.BuildNumber)"
                echo "Build ID: $(Build.BuildId)"
                echo ""
                echo "Artifacts published:"
                echo "  - migration-logs"
                echo "  - validation-logs"
                echo ""
                echo "Review artifacts for detailed migration results."
                echo "=========================================="

  - stage: PipelineRewiring
    displayName: 'Stage 5: Pipeline Rewiring'
    dependsOn: PostMigrationValidation
    condition: in(dependencies.PostMigrationValidation.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RewirePipelines
        displayName: 'Run Pipeline Rewiring'
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download repos_with_status.csv'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'migration-results'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare repos_with_status.csv'
            inputs:
              targetType: 'inline'
              script: |
                if [ -f "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" ]; then
                  cp "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" "$(System.DefaultWorkingDirectory)/repos_with_status.csv"
                  echo "‚úÖ repos_with_status.csv loaded ($(wc -l < repos_with_status.csv) lines)"
                else
                  echo "##[error]repos_with_status.csv not found in artifacts"
                  exit 1
                fi

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Rewire Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/4_rewire_pipeline.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Pipeline Rewiring'
            name: RewiringTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/4_rewire_pipeline.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Rewiring Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'rewiring-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Rewiring Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "PIPELINE REWIRING SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the rewiring-logs artifact for detailed results"
                echo "Log files: pipeline-rewiring-*.txt"
                echo "=========================================="

  - stage: AzureBoardsIntegration
    displayName: 'Stage 6: Boards Integration'
    dependsOn: PipelineRewiring
    condition: |
      and(
        eq('${{ parameters.runAzureBoardsIntegration }}', true),
        in(dependencies.PipelineRewiring.result, 'Succeeded', 'SucceededWithIssues', 'Failed', 'Skipped', 'Canceled')
      )
    # PAT Tokens Used: GH_PAT, ADO_PAT (from azure-boards-integration-secrets)
    # IMPORTANT: This stage uses a SEPARATE variable group with ADO_PAT having limited Boards-only scopes
    # This is NOT the same ADO_PAT used in migration stages
    variables:
      # Variable group for Azure Boards integration PAT tokens (Stage 6 only)
      # Contains: GH_PAT, ADO_PAT (separate token with limited Boards-only scopes)
      # Required scopes for ADO_PAT: Code (Read), Work Items (Read, Write), Project and Team (Read)
      - group: azure-boards-integration-secrets
    jobs:
      - job: IntegrateBoards
        displayName: 'Integrate Azure Boards with GitHub'
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download repos_with_status.csv'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'migration-results'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare repos_with_status.csv'
            inputs:
              targetType: 'inline'
              script: |
                if [ -f "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" ]; then
                  cp "$(System.DefaultWorkingDirectory)/migration-results/repos_with_status.csv" "$(System.DefaultWorkingDirectory)/repos_with_status.csv"
                  echo "‚úÖ repos_with_status.csv loaded ($(wc -l < repos_with_status.csv) lines)"
                else
                  echo "##[error]repos_with_status.csv not found in artifacts"
                  exit 1
                fi

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Azure Boards Integration Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/5_boards_integration.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Azure Boards Integration'
            name: BoardsIntegrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/5_boards_integration.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              # CRITICAL: Using ADO_PAT from azure-boards-integration-secrets variable group
              # This is a DIFFERENT token than migration ADO_PAT with Boards-only scopes
              ADO_PAT: $(ADO_PAT)
              GH_PAT: $(GH_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Azure Boards Integration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'boards-integration-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Azure Boards Integration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "AZURE BOARDS INTEGRATION SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the boards-integration-logs artifact for detailed results"
                echo "Log file: azure-boards-integration-*.log"
                echo "=========================================="

  - stage: DisableADORepositories
    displayName: 'Stage 7: Disable ADO Repos (Optional)'
    dependsOn: AzureBoardsIntegration
    condition: |
      and(
        eq('${{ parameters.runDisableADORepos }}', true),
        in(dependencies.AzureBoardsIntegration.result, 'Succeeded', 'SucceededWithIssues', 'Failed', 'Skipped', 'Canceled')
      )
    # PAT Tokens Used: GH_PAT, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: DisableRepositories
        displayName: 'Disable ADO Repositories'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Disable Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/6_disable_ado_repo.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Disable ADO Repositories'
            name: DisableReposTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/6_disable_ado_repo.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Disable Repos Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'disable-repos-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Disable ADO Repos Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "DISABLE ADO REPOSITORIES SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the disable-repos-logs artifact for detailed results"
                echo "Log file: disable-ado-repos-*.log"
                echo "=========================================="

  - stage: PipelineCompletion
    displayName: 'Pipeline Completion Summary'
    dependsOn:
      - PrerequisiteValidation
      - MigrationReadinessCheck
      - Migration
      - PostMigrationValidation
      - PipelineRewiring
      - AzureBoardsIntegration
      - DisableADORepositories
    condition: always()
    jobs:
      - job: CompletionSummary
        displayName: 'Pipeline Completion Summary'
        variables:
          stage1Result: $[ stageDependencies.PrerequisiteValidation.ValidatePrerequisites.result ]
          stage2Result: $[ stageDependencies.MigrationReadinessCheck.WaitForApprovalToMigrate.result ]
          stage3Result: $[ stageDependencies.Migration.RunMigration.result ]
          stage4Result: $[ stageDependencies.PostMigrationValidation.ValidationCheck.result ]
          stage5Result: $[ stageDependencies.PipelineRewiring.RewirePipelines.result ]
          stage6Result: $[ stageDependencies.AzureBoardsIntegration.IntegrateBoards.result ]
          stage7Result: $[ stageDependencies.DisableADORepositories.DisableRepositories.result ]
        steps:
          - task: PowerShell@2
            displayName: 'Display Pipeline Summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "=========================================="
                Write-Host "‚úÖ MIGRATION PIPELINE COMPLETED"
                Write-Host "=========================================="
                Write-Host "Build Number: $(Build.BuildNumber)"
                Write-Host ""
                Write-Host "Stage Results:"
                Write-Host "  Stage 1: Prerequisite Validation - $(stage1Result)"
                Write-Host "  Stage 2: Migration Readiness - $(stage2Result)"
                Write-Host "  Stage 3: Migrate Repositories - $(stage3Result)"
                if ("$(stage3Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed migration (check migration-logs)"
                }
                Write-Host "  Stage 4: Post-Migration Validation - $(stage4Result)"
                if ("$(stage4Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed validation (check validation-logs)"
                }
                Write-Host "  Stage 5: Rewire Pipelines - $(stage5Result)"
                if ("$(stage5Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some pipelines failed to rewire (check rewiring-logs)"
                }
                Write-Host "  Stage 6: Azure Boards Integration - $(stage6Result)"
                if ("$(stage6Result)" -eq "SucceededWithIssues") {
                    Write-Host "           ‚ö†Ô∏è Some repositories failed boards integration (check boards-integration-logs)"
                }
                Write-Host "  Stage 7: Disable ADO Repos - $(stage7Result)"
                if ("$(stage7Result)" -eq "Canceled" -or "$(stage7Result)" -eq "Skipped") {
                    Write-Host "           ‚ÑπÔ∏è Optional stage was skipped"
                }
                Write-Host ""
                Write-Host "Pipeline Status: Completed"
                Write-Host ""
                Write-Host "Status Indicators:"
                Write-Host "  ‚úÖ Succeeded - All operations completed successfully"
                Write-Host "  ‚ö†Ô∏è SucceededWithIssues - PARTIAL SUCCESS with some failures (review logs)"
                Write-Host "  ‚ùå Failed - Stage failed to complete"
                Write-Host "  ‚è∏Ô∏è Canceled - User rejected manual approval"
                Write-Host "  ‚è≠Ô∏è Skipped - Stage was skipped due to conditions/parameters"
                Write-Host ""
                Write-Host "Artifacts Available:"
                Write-Host "  - migration-logs: Repository migration details"
                Write-Host "  - validation-logs: Validation check results"
                Write-Host "  - rewiring-logs: Pipeline rewiring results"
                Write-Host "  - boards-integration-logs: Azure Boards integration results"
                Write-Host "  - disable-repos-logs: ADO repository disable results (if run)"
                Write-Host ""
                Write-Host "=========================================="
