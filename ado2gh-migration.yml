trigger: none

variables:
  # Variable group for migration-related PAT tokens (Stages 1-5)
  # Contains: GH_PAT, ADO_PAT (for migration, readiness checks, validation, rewiring)
  - group: core-entauto-github-migration-secrets
  
  - name: maxConcurrent
    value: 3  # Adjust based on your needs (1-5)

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: PrerequisiteValidation
    displayName: 'Prerequisite Validation'
    jobs:
      - job: ValidatePrerequisites
        displayName: 'Check Prerequisites'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Validate repos.csv File'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "=========================================="
                echo "PREREQUISITE VALIDATION"
                echo "=========================================="
                
                # Check if repos.csv exists
                CSV_FILE="bash/repos.csv"
                if [ ! -f "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file not found at $CSV_FILE"
                  exit 1
                fi
                echo "‚úÖ repos.csv file exists"
                
                # Check if file is not empty
                if [ ! -s "$CSV_FILE" ]; then
                  echo "‚ùå ERROR: repos.csv file is empty"
                  exit 1
                fi
                echo "‚úÖ repos.csv file is not empty"
                
                # Read header and validate required columns
                HEADER=$(head -n 1 "$CSV_FILE")
                echo ""
                echo "CSV Header: $HEADER"
                echo ""
                
                # Check for required columns for migration
                REQUIRED_COLUMNS=("org" "teamproject" "repo" "github_org" "github_repo" "gh_repo_visibility")
                MISSING_COLUMNS=()
                
                for col in "${REQUIRED_COLUMNS[@]}"; do
                  if ! echo "$HEADER" | grep -q "$col"; then
                    MISSING_COLUMNS+=("$col")
                  fi
                done
                
                if [ ${#MISSING_COLUMNS[@]} -gt 0 ]; then
                  echo "‚ùå ERROR: Missing required columns in repos.csv:"
                  for col in "${MISSING_COLUMNS[@]}"; do
                    echo "  - $col"
                  done
                  exit 1
                fi
                
                echo "‚úÖ All required columns present: ${REQUIRED_COLUMNS[*]}"
                
                # Count repositories to migrate
                REPO_COUNT=$(($(wc -l < "$CSV_FILE") - 1))
                echo ""
                echo "‚úÖ Found $REPO_COUNT repositories to process"
                echo "=========================================="

  - stage: MigrationReadinessCheck
    displayName: 'PR & Pipeline Check'
    dependsOn: PrerequisiteValidation
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ReadinessCheck
        displayName: 'Run Readiness Check Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Migration Readiness Check'
            inputs:
              targetType: 'filePath'
              filePath: 'bash/1_pr_pipeline_check.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
      
      - job: WaitForApprovalToMigrate
        displayName: '‚è∏Ô∏è Approve to START MIGRATION'
        dependsOn: ReadinessCheck
        condition: succeeded()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review Readiness & Approve Migration'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã Active PR & Pipeline Check COMPLETED
                
                ‚ö†Ô∏è **IMPORTANT**: The next stage will migrate repositories to GitHub.
                
                ### üìä What to Review
                1. Check the readiness check logs above
                2. Verify all repositories are accessible
                3. Confirm GitHub organizations exist
                4. Ensure permissions are validated
                
                ### ‚è≠Ô∏è Next Stage: Repo Migration
                This will:
                - Migrate repositories to GitHub
                - Transfer Git history
                - Create GitHub repositories
                
                ---
                
                ‚úÖ Click **Resume** to START MIGRATION
                ‚ùå Click **Reject** to stop the pipeline
              onTimeout: 'reject'

  - stage: Migration
    displayName: 'Repo Migration'
    dependsOn: MigrationReadinessCheck
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RunMigration
        displayName: 'Run Migration Script'
        steps:
          - checkout: self
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Execute Migration'
            name: MigrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/2_migration.sh'
              arguments: '--csv bash/repos.csv --max-concurrent $(maxConcurrent)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 120  # 2 hours timeout for large migrations
            continueOnError: true  # Don't fail job if some repos fail

          - task: Bash@3
            displayName: 'Check Migration Results'
            inputs:
              targetType: 'inline'
              script: |
                if [ ! -f "repos_stage3_success.csv" ]; then
                  echo "##[error]No successful migrations found - cannot proceed to validation"
                  exit 1
                fi
                
                SUCCESS_COUNT=$(($(wc -l < repos_stage3_success.csv) - 1))
                echo "##[section]Migration Stage Summary"
                echo "‚úÖ Successful migrations: ${SUCCESS_COUNT}"
                echo "üìã Filtered CSV created: repos_stage3_success.csv"
                
                if [ ${SUCCESS_COUNT} -eq 0 ]; then
                  echo "##[error]No repositories migrated successfully"
                  exit 1
                fi

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Migration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'migration-logs'
              publishLocation: 'Container'
            continueOnError: true

  - stage: PostMigrationValidation
    displayName: 'Migration Validation'
    dependsOn: Migration
    condition: in(dependencies.Migration.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: ValidationCheck
        displayName: 'Run Validation Script'
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Migration Results'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'migration-logs'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare Validation Input'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "##[section]Preparing filtered CSV for validation"
                
                if [ ! -f "migration-logs/repos_stage3_success.csv" ]; then
                  echo "##[error]repos_stage3_success.csv not found in migration-logs artifact"
                  exit 1
                fi
                
                # Copy filtered CSV to working location
                cp migration-logs/repos_stage3_success.csv bash/repos.csv
                
                REPO_COUNT=$(($(wc -l < bash/repos.csv) - 1))
                echo "‚úÖ Prepared ${REPO_COUNT} successfully migrated repos for validation"
                
                echo ""
                echo "First 5 repos to validate:"
                head -n 6 bash/repos.csv
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Execute Post-Migration Validation'
            name: ValidationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/3_post_migration_validation.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: Bash@3
            displayName: 'Check Validation Results'
            inputs:
              targetType: 'inline'
              script: |
                if [ ! -f "repos_stage4_success.csv" ]; then
                  echo "##[error]No successful validations found - cannot proceed"
                  exit 1
                fi
                
                SUCCESS_COUNT=$(($(wc -l < repos_stage4_success.csv) - 1))
                echo "##[section]Validation Stage Summary"
                echo "‚úÖ Successful validations: ${SUCCESS_COUNT}"
                echo "üìã Filtered CSV created: repos_stage4_success.csv"
                
                if [ ${SUCCESS_COUNT} -eq 0 ]; then
                  echo "##[error]No repositories validated successfully"
                  exit 1
                fi

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Validation Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'validation-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Migration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "MIGRATION SUMMARY"
                echo "=========================================="
                echo "Pipeline: $(Build.DefinitionName)"
                echo "Build Number: $(Build.BuildNumber)"
                echo "Build ID: $(Build.BuildId)"
                echo ""
                echo "Artifacts published:"
                echo "  - migration-logs"
                echo "  - validation-logs"
                echo ""
                echo "Review artifacts for detailed migration results."
                echo "=========================================="
      
      - job: WaitForApprovalToRewire
        displayName: '‚è∏Ô∏è Approve to START PIPELINE REWIRING'
        dependsOn: ValidationCheck
        condition: succeeded()
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review Validation & Approve Rewiring'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã Repo Migration Validation COMPLETED
                
                ‚ö†Ô∏è **IMPORTANT**: The next stage will rewire pipelines to use GitHub repositories.
                
                ### üìä What to Review
                1. Download and review the **migration-logs** artifact
                2. Download and review the **validation-logs** artifact
                3. Verify all repositories migrated successfully
                4. Check validation results for any issues
                5. Confirm commit history is intact
                
                ### ‚è≠Ô∏è Next Stage: Pipeline Rewiring
                This will:
                - Update ADO pipelines to point to GitHub repositories
                - Modify pipeline configurations
                - Change repository sources
                
                ### üìÅ Artifacts to Review
                - migration-logs: Migration execution details
                - validation-logs: Validation check results
                
                ---
                
                ‚úÖ Click **Resume** to START PIPELINE REWIRING
                ‚ùå Click **Reject** to stop before rewiring
              onTimeout: 'reject'

  - stage: PipelineRewiring
    displayName: 'Pipeline Rewiring'
    dependsOn: PostMigrationValidation
    condition: in(dependencies.PostMigrationValidation.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_TOKEN, ADO_PAT (from core-entauto-github-migration-secrets)
    jobs:
      - job: RewirePipelines
        displayName: 'Run Pipeline Rewiring'
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Validation Results'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'validation-logs'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare Rewiring Input'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "##[section]Preparing filtered CSV for pipeline rewiring"
                
                if [ ! -f "validation-logs/repos_stage4_success.csv" ]; then
                  echo "##[warning]repos_stage4_success.csv not found, using pipelines.csv"
                  # Rewiring uses pipelines.csv, not repos.csv
                  # But we document successful validations
                else
                  REPO_COUNT=$(($(wc -l < validation-logs/repos_stage4_success.csv) - 1))
                  echo "‚úÖ ${REPO_COUNT} repos successfully validated"
                  echo "Note: Pipeline rewiring uses bash/pipelines.csv (separate from repos)"
                fi
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Rewire Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/4_rewire_pipeline.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Pipeline Rewiring'
            name: RewiringTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/4_rewire_pipeline.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              GH_TOKEN: $(GH_PAT)
              GH_PAT: $(GH_PAT)
              ADO_PAT: $(ADO_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Rewiring Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'rewiring-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Rewiring Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "PIPELINE REWIRING SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the rewiring-logs artifact for detailed results"
                echo "Log files: pipeline-rewiring-*.txt"
                echo "=========================================="

  - stage: AzureBoardsIntegration
    displayName: 'Boards Integration'
    dependsOn: PipelineRewiring
    condition: in(dependencies.PipelineRewiring.result, 'Succeeded', 'SucceededWithIssues')
    # PAT Tokens Used: GH_PAT, ADO_PAT (from azure-boards-integration-secrets)
    # IMPORTANT: This stage uses a SEPARATE variable group with ADO_PAT having limited Boards-only scopes
    # This is NOT the same ADO_PAT used in migration stages
    variables:
      # Variable group for Azure Boards integration PAT tokens (Stage 6 only)
      # Contains: GH_PAT, ADO_PAT (separate token with limited Boards-only scopes)
      # Required scopes for ADO_PAT: Code (Read), Work Items (Read, Write), Project and Team (Read)
      - group: azure-boards-integration-secrets
    jobs:
      - job: WaitForApprovalToIntegrateBoards
        displayName: '‚è∏Ô∏è Approve to START AZURE BOARDS INTEGRATION'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            displayName: 'Review Rewiring & Approve Boards Integration'
            inputs:
              notifyUsers: '$(Build.RequestedForEmail)'
              instructions: |
                ## üìã Pipeline Rewiring COMPLETED
                
                ‚ö†Ô∏è **IMPORTANT**: The next stage will integrate Azure Boards with GitHub repositories.
                
                ### üìä What to Review
                1. Download and review the **rewiring-logs** artifact
                2. Verify pipelines were successfully rewired to GitHub
                3. Confirm all previous stages completed successfully
                4. Review migration, validation, and rewiring logs
                
                ### ‚è≠Ô∏è Next Stage: Azure Boards Integration
                This will:
                - Link Azure Boards work items to GitHub commits/PRs
                - Enable AB# mentions in GitHub to update work items
                - Configure GitHub ‚Üî Azure Boards synchronization
                
                ### üîí Security Note
                This stage uses a **separate ADO_PAT** with limited Boards-only permissions:
                - Code (Read only)
                - Work Items (Read, Write)
                - Project and Team (Read)
                
                ---
                
                ‚úÖ Click **Resume** to START AZURE BOARDS INTEGRATION
                ‚ùå Click **Reject** to skip Boards integration
              onTimeout: 'reject'
      
      - job: IntegrateBoards
        displayName: 'Integrate Azure Boards with GitHub'
        dependsOn: WaitForApprovalToIntegrateBoards
        condition: succeeded()
        steps:
          - checkout: self

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Validation Results'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'validation-logs'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Bash@3
            displayName: 'Prepare Boards Integration Input'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "##[section]Preparing filtered CSV for Azure Boards integration"
                
                if [ ! -f "validation-logs/repos_stage4_success.csv" ]; then
                  echo "##[error]repos_stage4_success.csv not found in validation-logs artifact"
                  exit 1
                fi
                
                # Copy filtered CSV to working location
                cp validation-logs/repos_stage4_success.csv bash/repos.csv
                
                REPO_COUNT=$(($(wc -l < bash/repos.csv) - 1))
                echo "‚úÖ Prepared ${REPO_COUNT} successfully validated repos for Boards integration"
                
                echo ""
                echo "First 5 repos to integrate:"
                head -n 6 bash/repos.csv
          
          - task: Bash@3
            displayName: 'Install GitHub CLI'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing GitHub CLI..."
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                sudo apt update
                sudo apt install gh -y
                
                echo ""
                echo "‚úÖ GitHub CLI installed:"
                gh --version

          - task: Bash@3
            displayName: 'Install gh-ado2gh Extension'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                echo "Installing gh-ado2gh extension..."
                gh extension install github/gh-ado2gh
                
                echo ""
                echo "‚úÖ Extension installed:"
                gh extension list
            env:
              GH_TOKEN: $(GH_PAT)

          - task: Bash@3
            displayName: 'Make Azure Boards Integration Script Executable'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x bash/5_boards_integration.sh
                echo "‚úÖ Script permissions set"

          - task: Bash@3
            displayName: 'Execute Azure Boards Integration'
            name: BoardsIntegrationTask
            inputs:
              targetType: 'filePath'
              filePath: 'bash/5_boards_integration.sh'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
            env:
              # CRITICAL: Using ADO_PAT from azure-boards-integration-secrets variable group
              # This is a DIFFERENT token than migration ADO_PAT with Boards-only scopes
              ADO_PAT: $(ADO_PAT)
              GH_PAT: $(GH_PAT)
            timeoutInMinutes: 60
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Azure Boards Integration Logs'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'boards-integration-logs'
              publishLocation: 'Container'
            continueOnError: true

          - task: Bash@3
            displayName: 'Azure Boards Integration Summary'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "=========================================="
                echo "AZURE BOARDS INTEGRATION SUMMARY"
                echo "=========================================="
                echo "Build Number: $(Build.BuildNumber)"
                echo ""
                echo "Check the boards-integration-logs artifact for detailed results"
                echo "Log file: azure-boards-integration-*.log"
                echo "=========================================="
